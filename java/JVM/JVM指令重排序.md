# 虚拟机

---

指令是指示计算机执行某种操作的命令，如：数据传送指令、算术运算指令、位运算指令、程序流程控制指令、串操作指令、处理器控制指令。指令不同于我们所写的代码，一行代码按照操作的逻辑可以分成多条指令。
     举个例子：int a = 1；  这段代码大致可以分为两条指令：1.加载常量1；2.将常量1赋值给变量a。
 
指令重排序
    Java语言规范JVM线程内部维持顺序花语义，即只要程序的最终结果与它顺序化情况的结果相等，那么指令的执行顺序可以与代码逻辑顺序不一致，这个过程就叫做指令的重排序。
    指令重排序的意义：使指令更加符合CPU的执行特性，最大限度的发挥机器的性能，提高程序的执行效率。
 
源代码到最终执行的指令序列示意图

指令重排序主要分为三种：
1.编译器重排序：JVM中进行完成的
2.指令级并行重排序
3.处理器重排序：CPU中进行完成的
 
As-If-Serial语义
    as-if-serial语义的意思是：不管怎么进行指令重排序，单线程内程序的执行结果不能被改变。编译器，处理器进行指令重排序都必须要遵守as-if-serial语义规则。
    为了遵守as-if-serial语义，编译器和处理器对存在依赖关系的操作，都不会对其进行重排序，因为这样的重排序很可能会改变执行的结果，但是对不存在依赖关系的操作，就有可能进行重排序。
 
Happens-Before原则
    happens-before可以理解为“先于”，是用来指定两个操作之间的执行顺序，由于这个两个操作可以在一个线程之内，也可以在不同线程之间。因此，JMM可以通过happens-before关系来保证跨线程的内存可见性（如果A线程是对变量进行写操作，而B线程是对变量进行读操作，那么如果A线程是先于B线程的操作，那么A线程写操作之后的数据对B线程也是可见的）
具体的定义：
    1.如果一个操作“先于”另一个操作，那么第一操作的执行结果将对第二个操作可见，而且第一个操作的执行顺序排在第二个操作之前；
    2.两个操作是happens-before的关系，也并不意味着JVM会按照这个关系去顺序执行，因为会存在重排序的可能，但是进行了重排序的执行结果，与此happens-before的关系顺序执行的结果一致的话，那就说明这个重排序是合法的（也就是JVM允许这样的重排序）。

1. as-if-serial语义保证单线程内程序的执行结果不被改变，happens-before关系保证正确同步的多线程程序的执行结果不被改变；
2.as-if-serial语义给编写单线程程序的程序员创造了一个幻境：单线程程序是按程序的顺序来执行的。happens-before关系给编写正确同步的多线程程序的程序员创造了一个幻境：正确同步的多线程程序是按happens-before指定的顺序来执行的；
3.as-if-serial语义和happens-before这么做的目的，都是为了在不改变程序执行结果的前提下，尽可能地提高程序执行的并行度。